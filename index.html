<!DOCTYPE html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="cache-control" content="no-cache, must-revalidate, post-check=0, pre-check=0" />
<meta http-equiv="cache-control" content="max-age=0" />
<meta http-equiv="expires" content="0" />
<meta http-equiv="expires" content="Tue, 01 Jan 1980 1:00:00 GMT" />
<meta http-equiv="pragma" content="no-cache" />
<meta http-equiv="refresh" content="1800" />
<meta property="og:description" content="Rauntímagögn um seinkanir á strætó" />
<meta property="og:image" content="featured.png">
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/safari-pinned-tab.svg">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">
<title>Er strætó seinn?</title>
<link rel="stylesheet" href="buses.css">
<style>
* {
  box-sizing: border-box;
}

.distance {
    margin-left: 8px;
    font-size: small;
    color: gray;
}

.trip-name {
    font-size: 20px;
    margin-top: 10px;
}

.next-bus {
    margin-left: 44px;
    margin-top: -3px;
}

.loading {
    font-style: italic;
    color: #808080;
    text-align: center;
}

.routenr {
    display: inline-block;
    width: 38px;
    line-height: 33px;
    height: 38px;
    border-radius: 50%;
    text-align: center;
    padding: 0;
    font-family: Arial;
    font-weight: 100;
    border: 3px solid transparent;
}

.trip-descriptor {
    display: flex;
    align-items: baseline;
    position: relative;
}

.trip-descriptor > .scheduled-departure {
    margin: 0;
    position: absolute;
    left: 44px;
    top: 46px;
    font-size: small;
}

.station {
    font-weight: bold;
}

.time {
    font-weight: bold;
}

fieldset {
    border: 2px solid #d4cb88;
    border-radius: 8px;
    padding: 15px;
    margin: 20px;
}

.stop-name {
    margin-top: 0px;
    text-align: center;
}

legend {
    font-size: x-large;
    font-weight: bold;
    text-align: center;
}

body {
  font: 16px Arial;
  text-align: center;
}

.autocomplete {
  position: relative;
  display: inline-block;
}

input {
  border: 1px solid transparent;
  background-color: #f1f1f1;
  padding: 10px;
  font-size: 16px;
}

input[type=text] {
  background-color: #f1f1f1;
  width: 100%;
}

input[type=submit] {
  background-color: LightBlue;
  color: #fff;
  width: 100px;
  padding: 10px;
}

.autocomplete-items {
  position: absolute;
  border: 1px solid #d4d4d4;
  border-bottom: none;
  border-top: none;
  z-index: 99;
  /*position the autocomplete items to be the same width as the container:*/
  top: 100%;
  left: 0;
  right: 0;
}

.autocomplete-items div {
  padding: 10px;
  cursor: pointer;
  background-color: #fff; 
  border-bottom: 1px solid #d4d4d4; 
}

/*when hovering an item:*/
.autocomplete-items div:hover {
  background-color: #e9e9e9; 
}

/*when navigating through the items using the arrow keys:*/
.autocomplete-active {
  background-color: DodgerBlue !important; 
  color: #ffffff; 
}

.logo {
    background: url(logo.svg) no-repeat;
    width: 52px;
    height: 52px;
    background-size: 100%;
    display: inline-block;
    vertical-align: middle;
}
img {
    width: min(42px, 8vw);
    height: min(42px, 8vw);
    padding: 4px;
    vertical-align: middle;
}
#results {
    margin-left: auto;
    margin-right: auto;
    max-width: min(600px, 99vw);
    text-align: left;
}
.result-text {
    color: #808080;
    width: min(300px, 50vw);
    text-align: justify;
    margin-left: auto;
    margin-right: auto;
}
.minutes {
    font-weight: bold;
    font-size: 30px;
    color: black;
}
.first-stop {
    margin-left: auto;
    margin-right: auto;
}
#daystatus {
    margin-top: 20px;
}
</style>
<body>
    <h1><a class="logo" href="/"></a> Er strætó seinn?</h1>
    <div id="content">
        <form autocomplete="off">
            <div class="first-stop" style="width: min(600px, 90vw);">
                <img id="crosshairs" src="crosshairs.png" onclick="fetchByLocation(true)">
                <div class="autocomplete" style="width: min(350px, 40vw);">
                    <input id="station" type="text" placeholder="Stoppistöð">
                </div>
            </div>
            <input type="hidden" name="stop" id="stop">
            <br>
        </form>
        <div id="results">
        </div>
    </div>
    <script src="stops.js"></script>
    <script src="names.js"></script>
    <script src="locations.js"></script>
    <script src="autocomplete.js"></script>
<script>
    var station_count = 2;
    autocomplete(document.getElementById("station"), names);
    countdown();
    var position;
    var byPosition = false;
    var byName = false;
    var refreshHandle;
    var xhrs = new Array();
    var station_name = '';
    freeze = false;

    function abort_all_xhr(){
        if (xhrs.length>0) {
            for(var i=0; i<xhrs.length; i++){
                xhrs[i].abort();
            }
            xhrs = [];
        };
    }
    function distance(lat1, lon1, lat2, lon2) {
        if ((lat1 == lat2) && (lon1 == lon2)) {
            return 0;
        }
        else {
            var radlat1 = Math.PI * lat1/180;
            var radlat2 = Math.PI * lat2/180;
            var theta = lon1-lon2;
            var radtheta = Math.PI * theta/180;
            var dist = Math.sin(radlat1) * Math.sin(radlat2) + Math.cos(radlat1) * Math.cos(radlat2) * Math.cos(radtheta);
            if (dist > 1) {
                dist = 1;
            }
            dist = Math.acos(dist);
            dist = dist * 180/Math.PI;
            dist = dist * 60 * 1.1515 * 1609.344;
            return dist;
        }
    }

    function formatDist(k) {
        if (k < 1000) {
            return Math.round(k) + " m";
        } else {
            return Math.round(k/100)/10 + " km";
        }
    }

    function setLoadingPlaceholder() {
        document.getElementById("results").innerHTML = '<p class="loading">Sæki gögn...</p>';
    }

    function fetchByLocation(force=false) {
        document.getElementById("crosshairs").src = "crosshairs.gif";
        document.getElementById("station").value = "";
        byPosition = true;
        byName = false;
        if (position && !force) {
            refreshSearch();
        } else {
            abort_all_xhr();
            setLoadingPlaceholder();
            fetchNearestStop();
        }
    }

    function fetchByName() {
        station_name = document.getElementById("station").value;
        byPosition = false;
        byName = true;
        abort_all_xhr();
        setLoadingPlaceholder();
        refreshSearch();
    }

    function fetchNearestStop() {
        byPosition = true;
        byName = false;
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(fetchStopComparison);
            setRefreshTimer();
        } else {
            return 0;
        }
    }
    function fetchStopComparison(pos) {
        position = pos;
        var xhr = new XMLHttpRequest();
        xhrs.push(xhr);
        xhr.open("GET", "data/?lat=" + pos.coords.latitude + "&lon=" + pos.coords.longitude + "&stations=" + station_count, true);
        xhr.onreadystatechange = function() {
            if (xhr.readyState == 4 && xhr.status == 200) {
                data = JSON.parse(xhr.responseText);
                printStops(data);
            }
        }
        xhr.send();
    }
    function setStation() {
        var xhr = new XMLHttpRequest();
        xhrs.push(xhr);
        xhr.open("GET", "data/?stop=" + station_name, true);
        xhr.onreadystatechange = function() {
            if (xhr.readyState == 4 && xhr.status == 200) {
                data = JSON.parse(xhr.responseText);
                printStops(data);
            }
        }
        xhr.send();
    }
    function formatTimeDifference(t, fall='nf') {
        fall_min = {
            'nf': 'mínútur',
            'þf': 'mínútur',
            'þgf': 'mínútum',
            'ef': 'mínútna',
        };
        fall_klst = {
            'nf': 'klukkustundir',
            'þf': 'klukkustundir',
            'þgf': 'klukkustundum',
            'ef': 'klukkustunda',
        };
        if (t > 60*60) {
            t_str = Math.floor(t/3600)+':'+('0'+Math.floor((t%3600)/60)).slice(-2) + " " + fall_klst[fall];
        } else {
            t_str = Math.floor(t/60)+':'+('0'+(t%60)).slice(-2) + " " + fall_min[fall];
        }

        return t_str;
    }
    function getTimeDifference(bustime, stoptime) {
        var bus = new Date(bustime);
        var stop = new Date(bustime.substr(0,11) + stoptime);
        var diff = (bus - stop) / 1000;
        return diff;
    }
    function getSmallerDiff(d1, d2) {
        if (Math.abs(d1) < Math.abs(d2)) {
            return d1;
        } else {
            return d2;
        }
    }
    function stopHTML(stop_id) {
        return '<span class="station">' + stops[stop_id] + '</span>';
    }
    function printStops(data) {
        min_dist = 50;
        time_sensitivity = 20;
        new_stops = [];
        stop_count = data['stops'];
        for (i = 1; i <= stop_count; i++) {
            dontadd = false;
            new_stop = document.createElement('fieldset');
            new_stop.className = "stop";
            new_stop.innerHTML = '<legend>' + data['stop_' + i].stop_name + '</legend>';
            already_printed = [];
            routes = [];
            data['stop_'+i].trips.forEach(function(trip) {
                delay_secs = 0;
                route_rename = trip.route_short_name;
                // if trip.route_id starts with 'RY.' or 'SA.', prefix 'R' or 'A' to route_rename
                if (trip.route_id.substr(0,3) == 'RY.') {
                    route_rename = 'R' + route_rename;
                } else if (trip.route_id.substr(0,3) == 'SA.') {
                    route_rename = 'A' + route_rename;
                }
                trip_name = '<span class="routenr route-' + route_rename + '">' + route_rename + '</span> ' + trip.trip_headsign;
                if (!already_printed.includes(trip_name)) {
                    already_printed.push(trip_name);
                    el_trip = document.createElement('div');
                    el_trip.className = "trip";
                    var dep_str = trip.departure_time;
                    if (trip.next_bus) {
                        lat1 = 1.0*trip.next_bus.lat;
                        lon1 = 1.0*trip.next_bus.lon;
                        lat2 = 1.0*data['stop_'+i].stop_lat;
                        lon2 = 1.0*data['stop_'+i].stop_lon;
                        bus_distance = distance(lat1,lon1,lat2,lon2);

                        late = false;
                        early = false;
                        next_stop_distance = false;
                        prev_stop_distance = false;
                        next_stop_close = false;
                        prev_stop_close = false;
                        next_stop_same = false;
                        prev_stop_same = false;
                        at_first = false;
                        going_from_here = false;

                        delay_secs = 0;

                        add_text = '<p class="next-bus">';

                        if (trip.next_bus.next_scheduled) {
                            next_stop_lat = locations[trip.next_bus.next_scheduled.stop_id][0];
                            next_stop_lon = locations[trip.next_bus.next_scheduled.stop_id][1];
                            next_stop_distance = distance(lat1,lon1,next_stop_lat,next_stop_lon);
                            next_diff = getSmallerDiff(getTimeDifference(trip.next_bus.time, trip.next_bus.next_scheduled.arrival_time), getTimeDifference(trip.next_bus.time, trip.preceding_trip.arrival_time));

                            if (trip.next_bus.next_scheduled.stop_id == data['stop_'+i].stop_id) {
                                next_stop_same = true;
                            }

                            if (next_diff > time_sensitivity) {
                                late = true;
                                delay_secs = next_diff;
                            }

                            if (next_stop_distance < min_dist) {
                                next_stop_close = true;
                            }
                        }
                        if (trip.next_bus.stop_scheduled) {
                            // strætó er á ferðinni
                            prev_stop_lat = locations[trip.next_bus.stop_scheduled.stop_id][0];
                            prev_stop_lon = locations[trip.next_bus.stop_scheduled.stop_id][1];
                            prev_stop_distance = distance(lat1,lon1,prev_stop_lat,prev_stop_lon);
                            prev_diff = getSmallerDiff(getTimeDifference(trip.next_bus.time, trip.next_bus.stop_scheduled.departure_time), getTimeDifference(trip.next_bus.time, trip.preceding_trip.departure_time));

                            if (trip.next_bus.stop == data['stop_'+i].stop_id) {
                                prev_stop_same = true;
                            }

                            if (trip.next_bus.stop_scheduled.stop_sequence == "1") {
                                at_first = true;
                            }

                            if (prev_diff < -time_sensitivity) {
                                early = true;
                            }

                            if (prev_stop_distance < min_dist) {
                                prev_stop_close = true;
                            }
                        }

                        if (next_stop_same) {
                            if (next_stop_close) {
                                add_text += 'Strætó er kominn. ';
                            } else {
                                add_text += 'Næsta stopp vagnsins er hér. ';
                            }
                        } else if (prev_stop_same) {
                            if (prev_stop_close) {
                                add_text += 'Strætó er að leggja af stað héðan. ';
                            } else {
                                add_text += 'Strætó er á leiðinni héðan á stoppið ' + stopHTML(trip.next_bus.next) + '. ';
                                going_from_here = true;
                            }
                        } else {
                            if (next_stop_close) {
                                add_text += 'Strætóinn er á stoppinu ' + stopHTML(trip.next_bus.next) + '. ';
                            } else if (prev_stop_close) {
                                add_text += 'Strætóinn er á stoppinu ' + stopHTML(trip.next_bus.stop) + '. ';
                            } else if (trip.next_schedule) {
                                add_text += 'Strætóinn er á leiðinni á stoppið ' + stopHTML(trip.next_bus.next) + '. ';
                            } else {
                                add_text += 'Strætóinn er á leiðinni frá stoppinu ' + stopHTML(trip.next_bus.stop) + '. ';
                            }
                        }

                        if (late) {
                            add_text += 'Hann er <span class="time">' + formatTimeDifference(next_diff, 'þgf') + '</span> á eftir áætlun. ';
                        } else if (early && !at_first) {
                            add_text += 'Hann er <span class="time">' + formatTimeDifference(-prev_diff, 'þgf') + '</span> á undan áætlun. ';
                        }

                        add_text += '</p>';

                        var now = new Date();
                        var datestring = now.getFullYear() + '-' + ('0'+(now.getMonth()+1)).slice(-2) + '-' + ('0'+now.getDate()).slice(-2);
                        var departure = new Date(datestring + ' ' + trip.departure_time);
                        var prev_departure = new Date(datestring + ' ' + trip.preceding_trip.departure_time);
                        if (prev_departure / 1000 + delay_secs + 30 > now/1000) {
                            dep_str = trip.preceding_trip.departure_time;
                        }
                        
                        el_trip.innerHTML = '<div class="trip-descriptor" data-sorter="' + dep_str + '"><h4 class="trip-name">' + trip_name + '<span class="distance" id="trip' + trip.trip_id + '">(' + formatDist(bus_distance) + ')</span></h4>' +
                                            '<span class="scheduled-departure" data-departure="' + dep_str + '" delay="' + delay_secs + '"></span></div>';
                        el_trip.innerHTML += add_text;
                    }
                    if (!dontadd)
                        routes.push([dep_str, el_trip]);
                }
            });
            sorted_routes = routes.sort(function(a, b) {
                return a[0] > b[0];
            });
            sorted_routes.forEach(function(route) {
                new_stop.appendChild(route[1]);
            });

            new_stops.push(new_stop);
        }
        document.getElementById("results").innerHTML = "";
        // loop through new_stops and append elements to results
        for (i = 0; i < new_stops.length; i++) {
            document.getElementById("results").appendChild(new_stops[i]);
        }
        countdown(false);
        document.getElementById("crosshairs").src = "crosshairs.png";
        setRefreshTimer();
    }
    function formatHMS(t) {
        var hms = t.split(':');
        return parseInt(hms[0]).toString() + ':' + hms[1];
    }
    function countdown(loop=true) {
        var now = new Date();
        var scheduled = document.getElementsByClassName('scheduled-departure');
        for (i = 0; i < scheduled.length; i++) {
            datestring = now.getFullYear() + '-' + ('0'+(now.getMonth()+1)).slice(-2) + '-' + ('0'+now.getDate()).slice(-2);
            var departure = new Date(datestring + ' ' + scheduled[i].getAttribute('data-departure'));
            var diff = Math.round((departure - now) / 1000);
            if (diff > 0) {
                scheduled[i].innerHTML = formatTimeDifference(diff) + " í áætlaða brottför kl. " + formatHMS(scheduled[i].getAttribute('data-departure'));
            } else {
                scheduled[i].innerHTML = 'Áætluð brottför var kl. ' + formatHMS(scheduled[i].getAttribute('data-departure')) + '.';
            }
        }
        if (loop)
            setTimeout(countdown, 1000);
    }
    function setRefreshTimer() {
        clearTimeout(refreshHandle);
        refreshHandle = setTimeout(refreshSearch, 10000);
    }
    function refreshSearch() {
        if (!freeze) {
            if (byPosition) {
                fetchStopComparison(position);
            }
            if (byName) {
                setStation();
            }
            setRefreshTimer();
        }
    }
</script>